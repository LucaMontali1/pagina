<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Profesores - Colegio Dante Alighieri</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary-color: #1a365d;
      --secondary-color: #2c5282;
      --accent-color: #3182ce;
      --light-blue: #e6f3ff;
      --success-color: #38a169;
      --warning-color: #d69e2e;
      --danger-color: #e53e3e;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f7fafc 0%, var(--light-blue) 100%);
      color: var(--text-primary);
      margin: 0;
      min-height: 100vh;
    }

    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26, 54, 93, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loading-content {
      text-align: center;
      color: white;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .security-warning {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(220, 38, 38, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
    }

    .warning-content {
      text-align: center;
      color: white;
      padding: 2rem;
    }

    .warning-content i {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .header {
      background: rgba(26, 54, 93, 0.95);
      backdrop-filter: blur(10px);
      color: white;
      padding: 1rem 0;
      box-shadow: var(--shadow-md);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .nav-buttons {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: white;
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: translateY(-1px);
    }

    .logout-btn {
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid rgba(220, 38, 38, 0.4);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(220, 38, 38, 0.4);
      transform: translateY(-1px);
    }

    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .levels-nav {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .level-btn {
      background: white;
      border: 2px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.75rem 1.5rem;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: var(--shadow-sm);
    }

    .level-btn:hover {
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .level-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .subjects-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .subject-card {
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }

    .subject-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .subject-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent-color);
    }

    .subject-card:hover::before {
      transform: scaleX(1);
    }

    .subject-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .subject-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--light-blue), rgba(49, 130, 206, 0.1));
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-color);
      font-size: 1.4rem;
    }

    .subject-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.4;
    }

    .subject-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 1200px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      position: relative;
    }

    .modal-header {
      background: var(--primary-color);
      color: white;
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
      transition: background 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .modal-body {
      padding: 2rem;
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 2rem;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 1rem 2rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .students-list {
      display: grid;
      gap: 1rem;
    }

    .student-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 1rem;
      align-items: center;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .student-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .attendance-controls {
      display: flex;
      gap: 0.5rem;
    }

    .attendance-btn {
      width: 40px;
      height: 40px;
      border: 2px solid;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }

    .attendance-btn.present {
      border-color: var(--success-color);
      color: var(--success-color);
    }

    .attendance-btn.present.active {
      background: var(--success-color);
      color: white;
    }

    .attendance-btn.absent {
      border-color: var(--danger-color);
      color: var(--danger-color);
    }

    .attendance-btn.absent.active {
      background: var(--danger-color);
      color: white;
    }

    .date-selector {
      margin-bottom: 2rem;
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .date-input {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
    }

    .save-attendance {
      background: var(--success-color);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .save-attendance:hover {
      background: #2f855a;
      transform: translateY(-2px);
    }

    .send-attendance-btn {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .send-attendance-btn:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
    }

    .grades-container {
      display: grid;
      gap: 1rem;
    }

    .global-grade-section {
      background: #fff3cd;
      border: 2px solid var(--warning-color);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .global-grade-section h3 {
      color: var(--warning-color);
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .global-grade-input {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .global-grade-input label {
      font-weight: 600;
    }

    .global-grade-input input, .global-grade-input select {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      min-width: 200px;
    }

    .apply-global-btn {
      background: var(--warning-color);
      color: white;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .apply-global-btn:hover {
      background: #b7791f;
    }

    .average-toggle {
      background: #e0f2fe;
      border: 2px solid var(--accent-color);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .average-toggle label {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .average-toggle input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .student-grades-row {
      display: grid;
      grid-template-columns: 2fr 3fr 1fr;
      gap: 1rem;
      align-items: center;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .grades-input-section {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .grade-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      align-items: center;
    }

    .grade-name-input {
      width: 80px;
      padding: 0.25rem 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      text-align: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      background: white;
    }

    .grade-name-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .grade-value-wrapper {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }

    .grade-input {
      width: 60px;
      padding: 0.5rem;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      text-align: center;
      font-weight: 600;
    }

    .grade-input:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .add-grade-btn {
      width: 30px;
      height: 30px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .add-grade-btn:hover {
      background: var(--secondary-color);
    }

    .remove-grade-btn {
      width: 25px;
      height: 25px;
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      font-size: 0.75rem;
    }

    .remove-grade-btn:hover {
      background: #c53030;
    }

    .average-display {
      font-weight: 600;
      color: var(--primary-color);
      min-width: 60px;
      text-align: center;
      padding: 0.5rem;
      background: white;
      border-radius: 6px;
      border: 2px solid var(--border-color);
    }

    .average-display input {
      width: 100%;
      border: none;
      text-align: center;
      font-weight: 600;
      color: var(--primary-color);
      background: transparent;
    }

    .average-display input:focus {
      outline: none;
      background: #f0f9ff;
    }

    .save-grades {
      background: var(--warning-color);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
      margin-right: 1rem;
    }

    .save-grades:hover {
      background: #b7791f;
      transform: translateY(-2px);
    }

    .send-grades-btn {
      background: #9333ea;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
      margin-right: 1rem;
    }

    .send-grades-btn:hover {
      background: #7c3aed;
      transform: translateY(-2px);
    }

    .send-excel-btn {
      background: #217346;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 1rem;
    }

    .send-excel-btn:hover {
      background: #1a5c37;
      transform: translateY(-2px);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 2rem;
      background: var(--success-color);
      color: white;
      border-radius: 8px;
      font-weight: 600;
      z-index: 9999;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      box-shadow: var(--shadow-lg);
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.error {
      background: var(--danger-color);
    }

    .notification.info {
      background: var(--accent-color);
    }

    .hidden {
      display: none !important;
    }

    #gradesCapture {
      position: absolute;
      left: -9999px;
      background: white;
      padding: 20px;
    }

    .capture-table {
      border-collapse: collapse;
      width: 100%;
      font-family: Arial, sans-serif;
    }

    .capture-table th,
    .capture-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    .capture-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
    }

    .capture-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    @media (max-width: 768px) {
      .main-container {
        padding: 1rem;
      }

      .subjects-grid {
        grid-template-columns: 1fr;
      }

      .student-row,
      .student-grades-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        text-align: center;
      }

      .modal-content {
        margin: 1rem;
      }

      .modal-body {
        padding: 1rem;
      }

      .levels-nav {
        justify-content: center;
      }

      .level-btn {
        flex: 1;
        min-width: 120px;
      }

      .grade-item {
        min-width: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>Verificando acceso...</h3>
      <p>Portal Profesores</p>
    </div>
  </div>

  <div class="security-warning" id="securityWarning">
    <div class="warning-content">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>¡Acceso Restringido!</h3>
      <p>Este panel es exclusivo para docentes. Serás redirigido.</p>
    </div>
  </div>

  <header class="header">
    <div class="header-content">
      <div class="logo">
        <i class="fas fa-graduation-cap"></i>
        Portal Profesores - Dante Alighieri
      </div>
      <div class="nav-buttons">
        <div class="user-info">
          <div class="user-avatar">
            <i class="fas fa-chalkboard-teacher"></i>
          </div>
          <span id="userName">Docente</span>
        </div>
        <a href="index.html" class="nav-btn">
          <i class="fas fa-home"></i> Inicio
        </a>
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </button>
      </div>
    </div>
  </header>

  <div class="main-container">
    <h1 style="text-align: center; margin-bottom: 2rem; color: var(--primary-color);">
      <i class="fas fa-chalkboard-teacher"></i>
      Sistema de Gestión Docente
    </h1>

    <div class="levels-nav">
      <button class="level-btn active" onclick="showLevel(1)">
        <i class="fas fa-baby"></i> 1° Año
      </button>
      <button class="level-btn" onclick="showLevel(2)">
        <i class="fas fa-child"></i> 2° Año
      </button>
      <button class="level-btn" onclick="showLevel(3)">
        <i class="fas fa-user-graduate"></i> 3° Año
      </button>
      <button class="level-btn" onclick="showLevel(4)">
        <i class="fas fa-user-tie"></i> 4° Año
      </button>
      <button class="level-btn" onclick="showLevel(5)">
        <i class="fas fa-trophy"></i> 5° Año
      </button>
    </div>

    <div id="level-1" class="level-content">
      <div class="subjects-grid" id="subjects-1"></div>
    </div>
    <div id="level-2" class="level-content hidden">
      <div class="subjects-grid" id="subjects-2"></div>
    </div>
    <div id="level-3" class="level-content hidden">
      <div class="subjects-grid" id="subjects-3"></div>
    </div>
    <div id="level-4" class="level-content hidden">
      <div class="subjects-grid" id="subjects-4"></div>
    </div>
    <div id="level-5" class="level-content hidden">
      <div class="subjects-grid" id="subjects-5"></div>
    </div>
  </div>

  <div class="modal-overlay" id="studentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Gestión de Estudiantes</h2>
        <button class="close-btn" onclick="closeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab-btn active" onclick="showTab('attendance')">
            <i class="fas fa-clipboard-check"></i> Asistencia
          </button>
          <button class="tab-btn" onclick="showTab('grades')">
            <i class="fas fa-star"></i> Calificaciones
          </button>
        </div>

        <div id="attendance-tab" class="tab-content active">
          <div class="date-selector">
            <label><strong>Fecha:</strong></label>
            <input type="date" class="date-input" id="attendanceDate" onchange="loadAttendanceTab()">
            <button class="save-attendance" onclick="saveAttendanceToSupabase()">
              <i class="fas fa-save"></i> Guardar en Base de Datos
            </button>
            <button class="send-attendance-btn" onclick="sendToPreceptoria()">
              <i class="fas fa-file-excel"></i> Enviar a Preceptoría
            </button>
          </div>
          <div class="students-list" id="attendanceList"></div>
        </div>

        <div id="grades-tab" class="tab-content">
          <div class="global-grade-section">
            <h3>
              <i class="fas fa-globe"></i> Configuración de Nota Global
            </h3>
            <p style="margin-bottom: 1rem; color: var(--text-secondary);">
              Define un nombre que se aplicará a todas las notas en la misma posición
            </p>
            <div class="global-grade-input">
              <label>Posición:</label>
              <select id="globalGradeIndex">
                <option value="0">Nota 1</option>
                <option value="1">Nota 2</option>
                <option value="2">Nota 3</option>
                <option value="3">Nota 4</option>
                <option value="4">Nota 5</option>
                <option value="5">Nota 6</option>
                <option value="6">Nota 7</option>
                <option value="7">Nota 8</option>
              </select>
              <label>Nombre:</label>
              <input type="text" id="globalGradeName" placeholder="Ej: TP1, Parcial..." maxlength="15">
              <button class="apply-global-btn" onclick="applyGlobalGradeName()">
                <i class="fas fa-check"></i> Aplicar a Todos
              </button>
            </div>
          </div>

          <div class="average-toggle">
            <label>
              <input type="checkbox" id="showAverageToggle" checked onchange="toggleAverageDisplay()">
              <i class="fas fa-calculator"></i> Mostrar Promedio (Editable)
            </label>
          </div>
          
          <div class="grades-container" id="gradesList"></div>
          <button class="save-grades" onclick="saveGradesToSupabase()">
            <i class="fas fa-save"></i> Guardar en Base de Datos
          </button>
          <button class="send-excel-btn" onclick="sendGradesToPreceptoriaExcel()">
            <i class="fas fa-file-excel"></i> Enviar Excel a Preceptoría
          </button>
          <button class="send-grades-btn" onclick="sendGradesToPreceptoria()">
            <i class="fas fa-image"></i> Enviar Imagen a Preceptoría
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="gradesCapture" class="hidden"></div>

  <script>
    // ============================================
    // SIMULADOR DE SESSION MANAGER (TEMPORAL)
    // ============================================
    const SessionManager = {
      verificarSesion: async function() {
        // Simular verificación de sesión
        const userData = localStorage.getItem('userData');
        if (!userData) {
          return { id: 'temp-teacher', username: 'profesor1', role: 'docente' };
        }
        return JSON.parse(userData);
      },
      verificarPermiso: function(roles) {
        return true; // Permitir acceso temporal
      },
      obtenerUsuarioActual: function() {
        const userData = localStorage.getItem('userData');
        if (!userData) {
          return { id: 'temp-teacher', username: 'profesor1', role: 'docente' };
        }
        return JSON.parse(userData);
      },
      cerrarSesion: function() {
        localStorage.removeItem('userData');
        window.location.href = 'index.html';
      }
    };

    // ============================================
    // CONFIGURACIÓN DE SUPABASE
    // ============================================
    const SUPABASE_URL = 'https://zcuodmndmrrvamyvgczm.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpjdW9kbW5kbXJydmFteXZnY3ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTA1ODMsImV4cCI6MjA2NzkyNjU4M30.l0XJgelYCQQ8sQyhL3XsY_4FOLGu6DwyZQ7PiocyLEE';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ============================================
    // MATERIAS POR AÑO
    // ============================================
    const subjectsByLevel = {
      1: [
        { name: 'Lengua y Literatura', icon: 'fas fa-book' },
        { name: 'Matemática', icon: 'fas fa-calculator' },
        { name: 'Historia', icon: 'fas fa-landmark' },
        { name: 'Geografía', icon: 'fas fa-globe-americas' },
        { name: 'Formación Ética y Ciudadana', icon: 'fas fa-balance-scale' },
        { name: 'Biología', icon: 'fas fa-leaf' },
        { name: 'Educación Tecnológica', icon: 'fas fa-cogs' },
        { name: 'Lengua Extranjera (Inglés)', icon: 'fas fa-language' },
        { name: 'Física', icon: 'fas fa-atom' },
        { name: 'Educación Artística (Plástica)', icon: 'fas fa-palette' },
        { name: 'Educación Artística (Teatro)', icon: 'fas fa-theater-masks' },
        { name: 'Educación Física', icon: 'fas fa-running' }
      ],
      2: [
        { name: 'Lengua y Literatura', icon: 'fas fa-book' },
        { name: 'Matemática', icon: 'fas fa-calculator' },
        { name: 'Historia', icon: 'fas fa-landmark' },
        { name: 'Geografía', icon: 'fas fa-globe-americas' },
        { name: 'Formación Ética y Ciudadana', icon: 'fas fa-balance-scale' },
        { name: 'Biología', icon: 'fas fa-leaf' },
        { name: 'Educación Tecnológica', icon: 'fas fa-cogs' },
        { name: 'Lengua Extranjera (Inglés)', icon: 'fas fa-language' },
        { name: 'Química', icon: 'fas fa-flask' },
        { name: 'Educación Artística (Plástica)', icon: 'fas fa-palette' },
        { name: 'Educación Artística (Teatro)', icon: 'fas fa-theater-masks' },
        { name: 'Educación Física', icon: 'fas fa-running' }
      ],
      3: [
        { name: 'Lengua y Literatura', icon: 'fas fa-book' },
        { name: 'Matemática', icon: 'fas fa-calculator' },
        { name: 'Historia', icon: 'fas fa-landmark' },
        { name: 'Geografía', icon: 'fas fa-globe-americas' },
        { name: 'Biología', icon: 'fas fa-leaf' },
        { name: 'Lengua Extranjera (Inglés)', icon: 'fas fa-language' },
        { name: 'Educación Física', icon: 'fas fa-running' },
        { name: 'Educación Artística (Plástica)', icon: 'fas fa-palette' },
        { name: 'Educación Artística (Teatro)', icon: 'fas fa-theater-masks' },
        { name: 'Aplicaciones para la Gestión de Oficinas', icon: 'fas fa-desktop' },
        { name: 'Tecnologías Informáticas de Comunicación', icon: 'fas fa-wifi' },
        { name: 'Diseño Multimedial', icon: 'fas fa-paint-brush' }
      ],
      4: [
        { name: 'Lengua y Literatura', icon: 'fas fa-book' },
        { name: 'Matemática', icon: 'fas fa-calculator' },
        { name: 'Historia', icon: 'fas fa-landmark' },
        { name: 'Geografía', icon: 'fas fa-globe-americas' },
        { name: 'Física', icon: 'fas fa-atom' },
        { name: 'Lengua Extranjera (Inglés)', icon: 'fas fa-language' },
        { name: 'Educación Física', icon: 'fas fa-running' },
        { name: 'Filosofía', icon: 'fas fa-brain' },
        { name: 'Aplicaciones para la Gestión de Oficinas II', icon: 'fas fa-desktop' },
        { name: 'Programación Imperativa', icon: 'fas fa-code' },
        { name: 'Sistemas de Procesamiento de Datos', icon: 'fas fa-database' },
        { name: 'Laboratorio Informático', icon: 'fas fa-laptop' }
      ],
      5: [
        { name: 'Lengua y Literatura', icon: 'fas fa-book' },
        { name: 'Formación Ética y Ciudadana', icon: 'fas fa-balance-scale' },
        { name: 'Matemática', icon: 'fas fa-calculator' },
        { name: 'Educación Física', icon: 'fas fa-running' },
        { name: 'Lengua Extranjera (Inglés)', icon: 'fas fa-language' },
        { name: 'Química', icon: 'fas fa-flask' },
        { name: 'Psicología', icon: 'fas fa-head-side-virus' },
        { name: 'Economía', icon: 'fas fa-chart-line' },
        { name: 'Programación Orientada a Objetos', icon: 'fas fa-code' },
        { name: 'Sistemas de Gestión de Bases de Datos', icon: 'fas fa-database' },
        { name: 'Proyecto de Investigación en Informática', icon: 'fas fa-search' }
      ]
    };

    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let currentLevel = 1;
    let currentSubject = null;
    let currentYear = null;
    let showAverage = true;
    let currentDocenteId = null;
    let students = [];

    // ============================================
    // VERIFICACIÓN DE SESIÓN
    // ============================================
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Primero cargar estudiantes
        await cargarEstudiantesDesdeSupabase();
        
        // Luego verificar sesión
        const sessionData = await SessionManager.verificarSesion();
        
        if (!sessionData) {
          return;
        }

        if (!SessionManager.verificarPermiso(['docente'])) {
          return;
        }

        const usuario = SessionManager.obtenerUsuarioActual();
        currentDocenteId = usuario.id;
        document.getElementById('userName').textContent = usuario.username || 'Docente';
        
        // Inicializar interfaz después de cargar datos
        showLevel(1);
        document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        
        // Ocultar pantalla de carga
        setTimeout(() => {
          const loadingScreen = document.getElementById('loadingScreen');
          if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
            }, 500);
          }
        }, 1000);
      } catch (error) {
        console.error('Error en inicialización:', error);
        showNotification('Error al inicializar el sistema', 'error');
      }
    });

    // ============================================
    // FUNCIÓN DE LOGOUT
    // ============================================
    function logout() {
      if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
        SessionManager.cerrarSesion();
      }
    }

    // ============================================
    // CARGAR ESTUDIANTES DESDE SUPABASE
    // ============================================
    async function cargarEstudiantesDesdeSupabase() {
      try {
        const { data, error } = await supabaseClient
          .from('usuarios')
          .select('id, nombre_completo, year')
          .eq('role', 'estudiante')
          .order('year', { ascending: true })
          .order('nombre_completo', { ascending: true });

        if (error) throw error;

        if (data && data.length > 0) {
          students = data.map(student => ({
            id: student.id,
            name: student.nombre_completo,
            year: student.year,
            attendance: {},
            grades: {},
            gradeNames: {},
            customAverage: {}
          }));
          console.log(`Cargados ${students.length} estudiantes desde Supabase`);
        } else {
          // Datos de demostración si no hay estudiantes en la BD
          cargarEstudiantesDemo();
        }
      } catch (error) {
        console.error('Error cargando estudiantes:', error);
        showNotification('Usando datos de demostración', 'info');
        cargarEstudiantesDemo();
      }
    }

    function cargarEstudiantesDemo() {
      students = [];
      const nombres = [
        'Juan Pérez', 'María González', 'Carlos Rodríguez', 'Ana Martínez',
        'Luis Fernández', 'Laura López', 'Pedro Sánchez', 'Sofía Ramírez',
        'Diego Torres', 'Valentina Flores', 'Mateo Silva', 'Camila Vargas',
        'Santiago Morales', 'Isabella Castro', 'Nicolás Ortiz', 'Lucía Herrera',
        'Sebastián Ruiz', 'Martina Díaz', 'Benjamín Rojas', 'Emma Jiménez'
      ];
      
      for (let year = 1; year <= 5; year++) {
        for (let i = 0; i < 20; i++) {
          students.push({
            id: `demo-${year}-${i}`,
            name: nombres[i] || `Estudiante ${i + 1}`,
            year: year,
            attendance: {},
            grades: {},
            gradeNames: {},
            customAverage: {}
          });
        }
      }
      console.log(`Cargados ${students.length} estudiantes de demostración`);
    }

    // ============================================
    // NAVEGACIÓN DE NIVELES
    // ============================================
    function showLevel(level) {
      currentLevel = level;
      document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.level-btn')[level - 1].classList.add('active');
      document.querySelectorAll('.level-content').forEach(content => content.classList.add('hidden'));
      document.getElementById(`level-${level}`).classList.remove('hidden');
      loadSubjects(level);
    }

    function loadSubjects(level) {
      const container = document.getElementById(`subjects-${level}`);
      const subjects = subjectsByLevel[level] || [];
      const studentsInYear = students.filter(s => s.year === level);
      
      container.innerHTML = '';
      subjects.forEach(subject => {
        const card = document.createElement('div');
        card.className = 'subject-card';
        card.innerHTML = `
          <div class="subject-header">
            <div class="subject-icon"><i class="${subject.icon}"></i></div>
            <h3 class="subject-name">${subject.name}</h3>
          </div>
          <div class="subject-info">
            <span><i class="fas fa-users"></i> ${studentsInYear.length} estudiantes</span>
            <span><i class="fas fa-calendar"></i> ${level}° Año</span>
          </div>
        `;
        card.addEventListener('click', () => openSubjectModal(subject.name, level));
        container.appendChild(card);
      });
    }

    function openSubjectModal(subjectName, year) {
      currentSubject = subjectName;
      currentYear = year;
      document.getElementById('modalTitle').innerHTML = `
        <i class="fas fa-chalkboard-teacher"></i> ${subjectName} - ${year}° Año
      `;
      loadAttendanceTab();
      loadGradesTab();
      document.getElementById('studentModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('studentModal').style.display = 'none';
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // ============================================
    // GESTIÓN DE ASISTENCIAS
    // ============================================
    function loadAttendanceTab() {
      const container = document.getElementById('attendanceList');
      const date = document.getElementById('attendanceDate').value;
      const studentsInYear = students.filter(s => s.year === currentYear);
      
      container.innerHTML = '';
      
      if (studentsInYear.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No hay estudiantes registrados para este año</p>';
        return;
      }
      
      studentsInYear.forEach(student => {
        const row = document.createElement('div');
        row.className = 'student-row';
        const attendanceKey = `${currentSubject}-${currentYear}-${date}`;
        const currentAttendance = student.attendance[attendanceKey] || null;
        
        row.innerHTML = `
          <div class="student-name">${student.name}</div>
          <div class="attendance-controls">
            <button class="attendance-btn present ${currentAttendance === true ? 'active' : ''}" 
                    onclick="setAttendance('${student.id}', true)">
              <i class="fas fa-check"></i>
            </button>
            <button class="attendance-btn absent ${currentAttendance === false ? 'active' : ''}" 
                    onclick="setAttendance('${student.id}', false)">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        container.appendChild(row);
      });
    }

    function setAttendance(studentId, isPresent) {
      const date = document.getElementById('attendanceDate').value;
      const attendanceKey = `${currentSubject}-${currentYear}-${date}`;
      const student = students.find(s => s.id === studentId);
      if (student) student.attendance[attendanceKey] = isPresent;
      loadAttendanceTab();
    }

    async function saveAttendanceToSupabase() {
      try {
        const date = document.getElementById('attendanceDate').value;
        const attendanceKey = `${currentSubject}-${currentYear}-${date}`;
        const studentsInYear = students.filter(s => s.year === currentYear);
        
        const studentsData = studentsInYear.map(s => ({
          id: s.id,
          name: s.name,
          status: s.attendance[attendanceKey] === true ? 'Presente' : 
                  s.attendance[attendanceKey] === false ? 'Ausente' : 'Sin registrar'
        }));

        const { data, error } = await supabaseClient
          .from('asistencias')
          .insert([{
            subject: currentSubject,
            year: currentYear,
            date: date,
            students: studentsData,
            docente_id: currentDocenteId
          }]);

        if (error) throw error;

        showNotification('Asistencia guardada en la base de datos exitosamente', 'success');
      } catch (error) {
        console.error('Error guardando asistencia:', error);
        showNotification('Error al guardar asistencia en la base de datos', 'error');
      }
    }

    function sendToPreceptoria() {
      if (!confirm('¿Deseas enviar la asistencia a Preceptoría? Esta acción enviará el registro.')) {
        return;
      }
      
      const date = document.getElementById('attendanceDate').value;
      const attendanceKey = `${currentSubject}-${currentYear}-${date}`;
      const studentsInYear = students.filter(s => s.year === currentYear);
      
      const wb = XLSX.utils.book_new();
      const wsData = [
        ['REPORTE DE ASISTENCIA'],
        ['Materia:', currentSubject],
        ['Año:', currentYear + '°'],
        ['Fecha:', date],
        [''],
        ['N°', 'Estudiante', 'Estado']
      ];
      
      studentsInYear.forEach((student, index) => {
        const status = student.attendance[attendanceKey] === true ? 'PRESENTE' : 
                      student.attendance[attendanceKey] === false ? 'AUSENTE' : 'SIN REGISTRAR';
        wsData.push([index + 1, student.name, status]);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      ws['!cols'] = [{wch: 5}, {wch: 30}, {wch: 15}];
      XLSX.utils.book_append_sheet(wb, ws, 'Asistencia');
      XLSX.writeFile(wb, `Asistencia_${currentSubject}_${currentYear}_${date}.xlsx`);
      
      showNotification('Asistencia enviada a Preceptoría como Excel', 'success');
    }

    // ============================================
    // GESTIÓN DE CALIFICACIONES
    // ============================================
    function toggleAverageDisplay() {
      showAverage = document.getElementById('showAverageToggle').checked;
      loadGradesTab();
    }

    function loadGradesTab() {
      const container = document.getElementById('gradesList');
      const studentsInYear = students.filter(s => s.year === currentYear);
      container.innerHTML = '';
      
      if (studentsInYear.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No hay estudiantes registrados para este año</p>';
        return;
      }
      
      studentsInYear.forEach(student => {
        const gradesKey = `${currentSubject}-${currentYear}`;
        const studentGrades = student.grades[gradesKey] || [];
        const studentGradeNames = student.gradeNames[gradesKey] || [];
        const customAverage = student.customAverage?.[gradesKey];
        
        const row = document.createElement('div');
        row.className = 'student-grades-row';
        row.setAttribute('data-student-id', student.id);
        
        const calculatedAverage = calculateAverage(studentGrades);
        const displayAverage = customAverage !== undefined ? customAverage : calculatedAverage;
        
        row.innerHTML = `
          <div class="student-name">${student.name}</div>
          <div class="grades-input-section" id="grades-${student.id}">
            ${generateGradeInputs(studentGrades, studentGradeNames, student.id)}
            <button class="add-grade-btn" onclick="addGradeInput('${student.id}')">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="average-display" id="average-${student.id}">
            ${showAverage ? `<input type="number" step="0.01" min="1" max="10" value="${displayAverage !== '--' ? displayAverage : ''}" 
                placeholder="${calculatedAverage}" 
                onchange="updateCustomAverage('${student.id}', this.value)"
                title="Promedio calculado: ${calculatedAverage}">` : 'N/A'}
          </div>
        `;
        container.appendChild(row);
      });
    }

    function generateGradeInputs(grades, gradeNames, studentId) {
      let html = '';
      const minInputs = Math.max(2, grades.length);
      
      for (let i = 0; i < minInputs; i++) {
        const value = grades[i] || '';
        const name = gradeNames[i] || `Nota ${i + 1}`;
        
        html += `
          <div class="grade-item">
            <input type="text" class="grade-name-input" value="${name}" 
                   onchange="updateGradeName('${studentId}', ${i}, this.value)"
                   placeholder="Nombre" maxlength="15">
            <div class="grade-value-wrapper">
              <input type="number" class="grade-input" min="1" max="10" 
                     value="${value}" onchange="updateGrade('${studentId}', ${i}, this.value)"
                     placeholder="--">
              ${i >= 2 && grades[i] !== undefined ? `
                <button class="remove-grade-btn" onclick="removeGradeInput('${studentId}', ${i})">
                  <i class="fas fa-times"></i>
                </button>` : ''}
            </div>
          </div>
        `;
      }
      return html;
    }

    function calculateAverage(grades) {
      if (!grades || grades.length === 0) return '--';
      const validGrades = grades.filter(grade => grade !== '' && grade !== null && grade !== undefined);
      if (validGrades.length === 0) return '--';
      const sum = validGrades.reduce((acc, grade) => acc + parseFloat(grade), 0);
      return (sum / validGrades.length).toFixed(2);
    }

    function updateGradeName(studentId, gradeIndex, name) {
      const gradesKey = `${currentSubject}-${currentYear}`;
      const student = students.find(s => s.id === studentId);
      if (student) {
        if (!student.gradeNames[gradesKey]) student.gradeNames[gradesKey] = [];
        student.gradeNames[gradesKey][gradeIndex] = name;
      }
    }

    function updateGrade(studentId, gradeIndex, value) {
      const gradesKey = `${currentSubject}-${currentYear}`;
      const student = students.find(s => s.id === studentId);
      if (student) {
        if (!student.grades[gradesKey]) student.grades[gradesKey] = [];
        student.grades[gradesKey][gradeIndex] = value === '' ? null : parseFloat(value);
        
        if (showAverage && !student.customAverage?.[gradesKey]) {
          const average = calculateAverage(student.grades[gradesKey]);
          const avgInput = document.querySelector(`#average-${studentId} input`);
          if (avgInput) {
            avgInput.placeholder = average;
          }
        }
      }
    }

    function updateCustomAverage(studentId, value) {
      const gradesKey = `${currentSubject}-${currentYear}`;
      const student = students.find(s => s.id === studentId);
      if (student) {
        if (!student.customAverage) student.customAverage = {};
        student.customAverage[gradesKey] = value === '' ? undefined : parseFloat(value);
      }
    }

    function addGradeInput(studentId) {
      const gradesKey = `${currentSubject}-${currentYear}`;
      const student = students.find(s => s.id === studentId);
      if (student) {
        if (!student.grades[gradesKey]) student.grades[gradesKey] = [];
        if (!student.gradeNames[gradesKey]) student.gradeNames[gradesKey] = [];
        const newIndex = student.grades[gradesKey].length;
        student.grades[gradesKey].push('');
        student.gradeNames[gradesKey].push(`Nota ${newIndex + 1}`);
        const container = document.getElementById(`grades-${student.id}`);
        container.innerHTML = `
          ${generateGradeInputs(student.grades[gradesKey], student.gradeNames[gradesKey], student.id)}
          <button class="add-grade-btn" onclick="addGradeInput('${student.id}')">
            <i class="fas fa-plus"></i>
          </button>
        `;
      }
    }

    function removeGradeInput(studentId, gradeIndex) {
      const gradesKey = `${currentSubject}-${currentYear}`;
      const student = students.find(s => s.id === studentId);
      if (student && student.grades[gradesKey]) {
        student.grades[gradesKey].splice(gradeIndex, 1);
        if (student.gradeNames[gradesKey]) student.gradeNames[gradesKey].splice(gradeIndex, 1);
        const container = document.getElementById(`grades-${student.id}`);
        container.innerHTML = `
          ${generateGradeInputs(student.grades[gradesKey], student.gradeNames[gradesKey], student.id)}
          <button class="add-grade-btn" onclick="addGradeInput('${student.id}')">
            <i class="fas fa-plus"></i>
          </button>
        `;
        
        if (showAverage && !student.customAverage?.[gradesKey]) {
          const average = calculateAverage(student.grades[gradesKey]);
          const avgInput = document.querySelector(`#average-${student.id} input`);
          if (avgInput) {
            avgInput.placeholder = average;
          }
        }
      }
    }

    function applyGlobalGradeName() {
      const gradeIndex = parseInt(document.getElementById('globalGradeIndex').value);
      const gradeName = document.getElementById('globalGradeName').value.trim();
      if (!gradeName) {
        showNotification('Por favor ingresa un nombre para la nota', 'error');
        return;
      }
      const gradesKey = `${currentSubject}-${currentYear}`;
      const studentsInYear = students.filter(s => s.year === currentYear);
      let appliedCount = 0;
      studentsInYear.forEach(student => {
        if (!student.gradeNames[gradesKey]) student.gradeNames[gradesKey] = [];
        student.gradeNames[gradesKey][gradeIndex] = gradeName;
        appliedCount++;
      });
      loadGradesTab();
      showNotification(`Nombre "${gradeName}" aplicado a ${appliedCount} estudiantes`, 'success');
      document.getElementById('globalGradeName').value = '';
    }

    async function saveGradesToSupabase() {
      try {
        const gradesKey = `${currentSubject}-${currentYear}`;
        const studentsInYear = students.filter(s => s.year === currentYear);
        
        const studentsData = studentsInYear.map(s => {
          const studentGrades = s.grades[gradesKey] || [];
          const studentGradeNames = s.gradeNames[gradesKey] || [];
          const customAverage = s.customAverage?.[gradesKey];
          const calculatedAverage = calculateAverage(studentGrades);
          const finalAverage = customAverage !== undefined ? customAverage : calculatedAverage;
          
          return {
            id: s.id,
            name: s.name,
            grades: studentGrades,
            gradeNames: studentGradeNames,
            average: finalAverage
          };
        });

        const { data, error } = await supabaseClient
          .from('calificaciones')
          .insert([{
            subject: currentSubject,
            year: currentYear,
            date: new Date().toISOString().split('T')[0],
            students: studentsData,
            type: 'manual',
            docente_id: currentDocenteId
          }]);

        if (error) throw error;

        showNotification('Calificaciones guardadas en la base de datos exitosamente', 'success');
      } catch (error) {
        console.error('Error guardando calificaciones:', error);
        showNotification('Error al guardar calificaciones en la base de datos', 'error');
      }
    }

    function sendGradesToPreceptoriaExcel() {
      if (!confirm('¿Deseas enviar las calificaciones a Preceptoría en formato Excel?')) {
        return;
      }
      
      const gradesKey = `${currentSubject}-${currentYear}`;
      const studentsInYear = students.filter(s => s.year === currentYear);
      
      let maxGrades = 0;
      studentsInYear.forEach(student => {
        const grades = student.grades[gradesKey] || [];
        if (grades.length > maxGrades) maxGrades = grades.length;
      });
      
      const wb = XLSX.utils.book_new();
      const wsData = [
        ['REPORTE DE CALIFICACIONES'],
        ['Materia:', currentSubject],
        ['Año:', currentYear + '°'],
        ['Fecha:', new Date().toLocaleDateString()],
        ['']
      ];
      
      const headers = ['N°', 'Estudiante'];
      for (let i = 0; i < maxGrades; i++) {
        const firstStudent = studentsInYear[0];
        const gradeName = firstStudent?.gradeNames[gradesKey] ? 
                         (firstStudent.gradeNames[gradesKey][i] || `Nota ${i+1}`) : 
                         `Nota ${i+1}`;
        headers.push(gradeName);
      }
      if (showAverage) {
        headers.push('Promedio');
      }
      wsData.push(headers);
      
      studentsInYear.forEach((student, index) => {
        const studentGrades = student.grades[gradesKey] || [];
        const customAverage = student.customAverage?.[gradesKey];
        const calculatedAverage = calculateAverage(studentGrades);
        const finalAverage = customAverage !== undefined ? customAverage : calculatedAverage;
        
        const row = [index + 1, student.name];
        
        for (let i = 0; i < maxGrades; i++) {
          row.push(studentGrades[i] || '--');
        }
        
        if (showAverage) {
          row.push(finalAverage !== '--' ? finalAverage : calculatedAverage);
        }
        
        wsData.push(row);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      const colWidths = [{wch: 5}, {wch: 30}];
      for (let i = 0; i < maxGrades; i++) {
        colWidths.push({wch: 12});
      }
      if (showAverage) {
        colWidths.push({wch: 12});
      }
      ws['!cols'] = colWidths;
      
      XLSX.utils.book_append_sheet(wb, ws, 'Calificaciones');
      XLSX.writeFile(wb, `Calificaciones_${currentSubject}_${currentYear}_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      showNotification('Calificaciones enviadas a Preceptoría como Excel', 'success');
    }

    function sendGradesToPreceptoria() {
      const gradesKey = `${currentSubject}-${currentYear}`;
      const captureDiv = document.getElementById('gradesCapture');
      const studentsInYear = students.filter(s => s.year === currentYear);
      
      let maxGrades = 0;
      studentsInYear.forEach(student => {
        const grades = student.grades[gradesKey] || [];
        if (grades.length > maxGrades) maxGrades = grades.length;
      });
      
      let tableHTML = `
        <div style="padding: 20px; background: white;">
          <h2 style="text-align: center; color: #1a365d; margin-bottom: 10px;">
            CALIFICACIONES - ${currentSubject}
          </h2>
          <p style="text-align: center; color: #666; margin-bottom: 20px;">
            ${currentYear}° Año - ${new Date().toLocaleDateString()}
          </p>
          <table class="capture-table">
            <thead>
              <tr>
                <th style="width: 40px;">N°</th>
                <th style="width: 200px;">Estudiante</th>
      `;
      
      for (let i = 0; i < maxGrades; i++) {
        const firstStudent = studentsInYear[0];
        const gradeName = firstStudent?.gradeNames[gradesKey] ? 
                         (firstStudent.gradeNames[gradesKey][i] || `Nota ${i+1}`) : 
                         `Nota ${i+1}`;
        tableHTML += `<th>${gradeName}</th>`;
      }
      
      if (showAverage) {
        tableHTML += `<th style="background-color: #3182ce;">Promedio</th>`;
      }
      
      tableHTML += `</tr></thead><tbody>`;
      
      studentsInYear.forEach((student, index) => {
        const studentGrades = student.grades[gradesKey] || [];
        const customAverage = student.customAverage?.[gradesKey];
        const calculatedAverage = calculateAverage(studentGrades);
        const finalAverage = customAverage !== undefined ? customAverage : calculatedAverage;
        
        tableHTML += `<tr><td>${index + 1}</td><td style="text-align: left;">${student.name}</td>`;
        
        for (let i = 0; i < maxGrades; i++) {
          const grade = studentGrades[i] || '--';
          tableHTML += `<td>${grade}</td>`;
        }
        
        if (showAverage) {
          const avgDisplay = finalAverage !== '--' ? finalAverage : calculatedAverage;
          tableHTML += `<td style="font-weight: bold; background-color: #e6f3ff;">${avgDisplay}</td>`;
        }
        
        tableHTML += `</tr>`;
      });
      
      tableHTML += `</tbody></table></div>`;
      captureDiv.innerHTML = tableHTML;
      captureDiv.style.left = '0';
      captureDiv.style.position = 'fixed';
      
      setTimeout(() => {
        html2canvas(captureDiv, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        }).then(canvas => {
          canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Calificaciones_${currentSubject}_${currentYear}_${new Date().toISOString().split('T')[0]}.png`;
            a.click();
            URL.revokeObjectURL(url);
            
            captureDiv.style.left = '-9999px';
            captureDiv.style.position = 'absolute';
            showNotification('Calificaciones enviadas como imagen a Preceptoría', 'success');
          });
        });
      }, 100);
    }

    // ============================================
    // NOTIFICACIONES
    // ============================================
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 2rem;
        background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--accent-color)'};
        color: white;
        border-radius: 8px;
        font-weight: 600;
        z-index: 9999;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        box-shadow: var(--shadow-lg);
      `;
      notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => {
          if (notification.parentNode) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.addEventListener('click', function(e) {
      if (e.target === document.getElementById('studentModal')) closeModal();
    });

    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });

    window.addEventListener('popstate', function(event) {
      history.pushState(null, null, location.href);
    });

    history.pushState(null, null, location.href);

    document.addEventListener('keydown', function(event) {
      const blockedKeys = [
        { key: 'F12' },
        { key: 'I', ctrl: true, shift: true },
        { key: 'C', ctrl: true, shift: true },
        { key: 'J', ctrl: true, shift: true },
        { key: 'U', ctrl: true }
      ];

      const currentKey = {
        key: event.key,
        ctrl: event.ctrlKey,
        shift: event.shiftKey
      };

      const isBlocked = blockedKeys.some(blocked => {
        return blocked.key === currentKey.key &&
               (blocked.ctrl === undefined || blocked.ctrl === currentKey.ctrl) &&
               (blocked.shift === undefined || blocked.shift === currentKey.shift);
      });

      if (isBlocked) {
        event.preventDefault();
        return false;
      }
    });

    document.addEventListener('contextmenu', function(event) {
      event.preventDefault();
      return false;
    });

    console.log('%c🔒 PORTAL PROFESORES SEGURO', 
      'color: #3182ce; font-size: 20px; font-weight: bold;');
    console.log('%cAcceso restringido solo para docentes autorizados.', 
      'color: #d69e2e; font-size: 14px;');
  </script>
</body>
</html>